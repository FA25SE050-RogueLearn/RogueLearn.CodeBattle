<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CodeBattle Room</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
                background-color: #f4f4f4;
            }
            .container {
                max-width: 1400px;
                margin: auto;
                background: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }
            h1,
            h2,
            h3 {
                color: #333;
            }
            .columns {
                display: flex;
                gap: 20px;
            }
            .col-left {
                flex: 1;
            }
            .col-right {
                flex: 2;
                min-width: 0;
            }
            #leaderboard,
            #problem-area,
            #problem-description-container {
                border: 1px solid #ddd;
                padding: 15px;
                border-radius: 5px;
            }
            #leaderboard {
                min-height: 100px;
                margin-bottom: 20px;
            }
            #problem-area {
                min-height: 400px;
            }
            #leaderboard-toggle {
                cursor: pointer;
                user-select: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                background-color: #f7f7f7;
                border: 1px solid #ddd;
                border-bottom: none;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }
            button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            }
            button:hover {
                background-color: #0056b3;
            }
            ul {
                list-style-type: none;
                padding: 0;
            }
            li {
                background: #eee;
                margin-bottom: 5px;
                padding: 10px;
                border-radius: 3px;
            }
            #code-editor-container {
                width: 100%;
                height: 400px;
                border: 1px solid #ddd;
                margin-top: 10px;
                position: relative;
            }
            #problem-selector,
            #language-selector {
                padding: 8px;
                margin-top: 10px;
                border-radius: 5px;
                border: 1px solid #ddd;
            }
            #notifications {
                margin-top: 20px;
                border: 1px solid #ccc;
                padding: 10px;
                background-color: #f9f9f9;
                max-height: 150px;
                overflow-y: auto;
            }
            #problem-description {
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid #eee;
                min-height: 50px;
            }
            #problem-description h1,
            #problem-description h2,
            #problem-description h3 {
                margin-top: 15px;
                color: #333;
            }
            #problem-description p {
                line-height: 1.6;
            }
            #problem-description code {
                background-color: #eee;
                padding: 2px 5px;
                border-radius: 4px;
                font-family: monospace;
            }
            #problem-description pre {
                background-color: #2d2d2d;
                color: #f8f8f2;
                padding: 15px;
                border-radius: 5px;
                overflow-x: auto;
            }
            #problem-description pre code {
                background-color: transparent;
                padding: 0;
            }
            #problem-description ul,
            #problem-description ol {
                padding-left: 20px;
                list-style-type: revert;
            }
            #problem-description li {
                background: transparent;
                padding: 2px;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>
    <body>
        <div class="container">
            <h1>Room: <span id="room-name">Loading...</span></h1>
            <p>
                Playing as <strong id="player-name"></strong> |
                <a href="/index.html"> &larr; Back to Lobby</a>
            </p>
            <hr />

            <div class="columns">
                <div class="col-left">
                    <h2 id="leaderboard-toggle">
                        Leaderboard <span id="leaderboard-caret">▼</span>
                    </h2>
                    <div id="leaderboard">
                        <ul id="leaderboard-list">
                            <p>Connecting to leaderboard...</p>
                        </ul>
                    </div>

                    <div
                        id="problem-description-container"
                        style="display: none"
                    >
                        <h3>Problem Details</h3>
                        <div id="problem-description">
                            <p>Select a problem to see its description.</p>
                        </div>
                    </div>
                </div>

                <div class="col-right">
                    <h2>Problem Solver</h2>
                    <div id="problem-area">
                        <label for="problem-selector">Choose a problem:</label>
                        <select id="problem-selector">
                            <option>Loading problems...</option>
                        </select>

                        <div id="submission-view" style="display: none">
                            <h3 id="problem-title"></h3>
                            <h4>Submit Your Solution</h4>
                            <div id="code-editor-container"></div>
                            <br />
                            <select id="language-selector">
                                <option value="go">Go</option>
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                            </select>
                            <button id="submit-code">Submit Solution</button>
                            <div
                                id="submission-result"
                                style="margin-top: 10px"
                            ></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="notifications">
                <h2>Real-time Notifications</h2>
                <ul id="notifications-list"></ul>
            </div>
        </div>

        <script>
            const API_BASE_URL = "http://localhost:8080";
            let playerID = null;

            let eventSource = null;
            let currentEventId = null;
            let currentRoomId = null;
            let selectedProblemId = null;
            let editor = null;

            // --- Editor Functions ---
            function createEditor(initialLanguage, initialCode) {
                require(["vs/editor/editor.main"], () => {
                    if (editor) {
                        editor.setValue(initialCode);
                        monaco.editor.setModelLanguage(
                            editor.getModel(),
                            initialLanguage,
                        );
                        editor.layout();
                    } else {
                        editor = monaco.editor.create(
                            document.getElementById("code-editor-container"),
                            {
                                value: initialCode,
                                language: initialLanguage,
                                theme: "vs-dark",
                                automaticLayout: true,
                            },
                        );
                    }
                });
            }

            // --- Helper Functions ---
            function logNotification(message, type = "info") {
                const notificationsList =
                    document.getElementById("notifications-list");
                const li = document.createElement("li");
                li.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

                if (type === "success") {
                    li.style.backgroundColor = "#d4edda";
                    li.style.color = "#155724";
                } else if (type === "error") {
                    li.style.backgroundColor = "#f8d7da";
                    li.style.color = "#721c24";
                }

                notificationsList.appendChild(li);
                notificationsList.scrollTop = notificationsList.scrollHeight;
            }

            // --- API Functions ---
            async function getProblemDescription(problemId) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/problems/${problemId}`,
                    );
                    if (!response.ok)
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    const data = await response.json();
                    if (data.success && data.data) {
                        console.log("Problem Description Data:", data.data);
                        return data.data;
                    }
                    return null;
                } catch (error) {
                    console.error("Error fetching problem details:", error);
                    logNotification(
                        `Error fetching details for problem ${problemId}.`,
                        "error",
                    );
                    return null;
                }
            }

            async function getLanguageTemplate(problemId, language) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/problems/${problemId}/details?lang=${language}`,
                    );
                    if (!response.ok)
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    const data = await response.json();
                    if (data.success && data.data) {
                        console.log("Language Template Data:", data.data);
                        return data.data;
                    }
                    return null;
                } catch (error) {
                    console.error("Error fetching language template:", error);
                    logNotification(
                        `Error fetching template for ${language}.`,
                        "error",
                    );
                    return null;
                }
            }

            async function getProblemsForRoom(eventId, roomId) {
                const selector = document.getElementById("problem-selector");
                selector.innerHTML = "<option>Loading problems...</option>";
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/events/${eventId}/rooms/${roomId}/problems`,
                    );
                    const data = await response.json();
                    selector.innerHTML =
                        '<option value="">-- Select a Problem --</option>';
                    if (data.data && data.data.length > 0) {
                        data.data.forEach((problem) => {
                            const option = document.createElement("option");
                            option.value = problem.CodeProblemID;
                            option.textContent = `${problem.Title} (Score: ${problem.Score})`;
                            option.dataset.problemTitle = problem.Title;
                            selector.appendChild(option);
                        });
                    } else {
                        selector.innerHTML =
                            "<option>No problems found for this room.</option>";
                    }
                } catch (error) {
                    console.error("Error fetching problems:", error);
                    selector.innerHTML =
                        "<option>Error fetching problems.</option>";
                    logNotification(
                        `Error fetching problems for room ${roomId}.`,
                        "error",
                    );
                }
            }

            // --- SSE Connection ---
            function joinRoom(eventId, roomId) {
                if (eventSource) {
                    eventSource.close();
                }
                const leaderboardList =
                    document.getElementById("leaderboard-list");
                leaderboardList.innerHTML =
                    "<p>Connecting to leaderboard...</p>";

                const url = `${API_BASE_URL}/events/${eventId}/rooms/${roomId}/leaderboard?connected_player_id=${playerID}`;
                eventSource = new EventSource(url);

                eventSource.onopen = () =>
                    logNotification(
                        `SSE connection opened for room ${roomId}.`,
                    );

                eventSource.onerror = (error) => {
                    console.error("EventSource failed:", error);
                    logNotification("SSE connection error.", "error");
                    leaderboardList.innerHTML =
                        "<p>Could not connect to leaderboard.</p>";
                    eventSource.close();
                };

                eventSource.addEventListener(
                    "CORRECT_SOLUTION_SUBMITTED",
                    (e) => {
                        logNotification(
                            "A correct solution was submitted! Leaderboard will update.",
                            "success",
                        );
                        document.getElementById("submission-result").innerHTML =
                            `<div style="color: green;"><strong>Success!</strong> Solution Accepted.</div>`;
                    },
                );

                eventSource.addEventListener(
                    "WRONG_SOLUTION_SUBMITTED",
                    (e) => {
                        const eventData = JSON.parse(e.data);
                        const errorMessage =
                            eventData.Data || "Your solution failed.";
                        logNotification(
                            `Your solution failed: ${errorMessage}`,
                            "error",
                        );
                        document.getElementById("submission-result").innerHTML =
                            `<div style="color: red;"><strong>Failed:</strong> ${errorMessage}</div>`;
                    },
                );

                eventSource.addEventListener("LEADERBOARD_UPDATED", (e) => {
                    logNotification("Leaderboard updated.");
                    leaderboardList.innerHTML = "";
                    try {
                        const entries = JSON.parse(e.data).Data;
                        if (Array.isArray(entries) && entries.length > 0) {
                            entries.sort((a, b) => a.place - b.place);
                            entries.forEach((entry) => {
                                const li = document.createElement("li");
                                li.textContent = `#${entry.place} - ${entry.player_name} (Score: ${entry.score})`;
                                leaderboardList.appendChild(li);
                            });
                        } else {
                            leaderboardList.innerHTML =
                                "<p>No players on the leaderboard yet.</p>";
                        }
                    } catch (error) {
                        console.error("Error parsing leaderboard data:", error);
                        logNotification(
                            "Failed to update leaderboard.",
                            "error",
                        );
                        leaderboardList.innerHTML =
                            "<p>Error updating leaderboard.</p>";
                    }
                });

                eventSource.addEventListener("PLAYER_JOINED", (e) =>
                    logNotification("A player has joined the room."),
                );
                eventSource.addEventListener("PLAYER_LEFT", (e) =>
                    logNotification("A player has left the room."),
                );
            }

            // --- Event Listeners ---
            document
                .getElementById("leaderboard-toggle")
                .addEventListener("click", () => {
                    const list = document.getElementById("leaderboard-list");
                    const caret = document.getElementById("leaderboard-caret");
                    const isCollapsed = list.style.display === "none";

                    if (isCollapsed) {
                        list.style.display = "block";
                        caret.textContent = "▼";
                    } else {
                        list.style.display = "none";
                        caret.textContent = "▶";
                    }
                });

            document
                .getElementById("problem-selector")
                .addEventListener("change", async (e) => {
                    selectedProblemId = e.target.value;
                    const selectedOption =
                        e.target.options[e.target.selectedIndex];

                    const submissionView =
                        document.getElementById("submission-view");
                    const descriptionContainer = document.getElementById(
                        "problem-description-container",
                    );

                    if (!selectedProblemId) {
                        submissionView.style.display = "none";
                        descriptionContainer.style.display = "none";
                        return;
                    }

                    submissionView.style.display = "block";
                    descriptionContainer.style.display = "block";

                    document.getElementById("problem-title").textContent =
                        selectedOption.dataset.problemTitle;
                    document.getElementById("submission-result").innerHTML = "";

                    const fullDetails =
                        await getProblemDescription(selectedProblemId);

                    const problemDescriptionEl = document.getElementById(
                        "problem-description",
                    );

                    try {
                        const statement =
                            fullDetails &&
                            typeof fullDetails.problem_statement === "string"
                                ? fullDetails.problem_statement
                                : "";

                        if (statement) {
                            if (typeof marked !== "undefined" && marked.parse) {
                                problemDescriptionEl.innerHTML =
                                    marked.parse(statement);
                            } else {
                                problemDescriptionEl.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit;">${statement}</pre>`;
                            }
                        } else {
                            problemDescriptionEl.innerHTML =
                                "<p>Could not load problem description.</p>";
                        }
                    } catch (err) {
                        console.error("Error parsing markdown:", err);
                        problemDescriptionEl.innerHTML =
                            "<p>Error displaying problem description.</p>";
                    }

                    const language =
                        document.getElementById("language-selector").value;
                    const langDetails = await getLanguageTemplate(
                        selectedProblemId,
                        language,
                    );

                    const initialCode =
                        langDetails && langDetails.solution_stub
                            ? langDetails.solution_stub
                            : `// Could not load template for ${selectedOption.dataset.problemTitle}\n`;
                    createEditor(language, initialCode);
                });

            document
                .getElementById("language-selector")
                .addEventListener("change", async (e) => {
                    const newLanguage = e.target.value;
                    if (editor && selectedProblemId) {
                        const details = await getLanguageTemplate(
                            selectedProblemId,
                            newLanguage,
                        );
                        const newCode =
                            details && details.solution_stub
                                ? details.solution_stub
                                : `// Could not load template for this language.\n`;
                        editor.setValue(newCode);
                        monaco.editor.setModelLanguage(
                            editor.getModel(),
                            newLanguage,
                        );
                    }
                });

            document
                .getElementById("submit-code")
                .addEventListener("click", async () => {
                    if (!editor) return alert("Editor is not initialized.");
                    if (!selectedProblemId)
                        return alert("Please select a problem.");

                    const code = editor.getValue();
                    if (!code.trim())
                        return alert("Code editor cannot be empty.");

                    const resultContainer =
                        document.getElementById("submission-result");
                    resultContainer.innerHTML = `<div style="color: blue;">Submitting...</div>`;

                    const language =
                        document.getElementById("language-selector").value;
                    const url = `${API_BASE_URL}/events/${currentEventId}/rooms/${currentRoomId}/submit?player_id=${playerID}`;

                    try {
                        const response = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: "Bearer your-jwt-token",
                            },
                            body: JSON.stringify({
                                problem_id: selectedProblemId,
                                code: code,
                                language: language,
                            }),
                        });
                        const result = await response.json();
                        if (result.success) {
                            resultContainer.innerHTML = `<div style="color: blue;">${result.message}</div>`;
                            logNotification(
                                `Solution submitted for processing.`,
                            );
                        } else {
                            resultContainer.innerHTML = `<div style="color: red;">Submission failed: ${result.error_message}</div>`;
                            logNotification(
                                `Submission failed: ${result.error_message}`,
                                "error",
                            );
                        }
                    } catch (error) {
                        console.error("Error submitting solution:", error);
                        resultContainer.innerHTML = `<div style="color: red;">An error occurred.</div>`;
                        logNotification("Error submitting solution.", "error");
                    }
                });

            // --- Page Initialization ---
            document.addEventListener("DOMContentLoaded", () => {
                playerID = localStorage.getItem("codebattle_player_id");
                const playerName = localStorage.getItem(
                    "codebattle_player_name",
                );

                if (!playerID || !playerName) {
                    window.location.href = "/login.html";
                    return;
                }

                document.getElementById("player-name").textContent = playerName;

                const params = new URLSearchParams(window.location.search);
                currentEventId = params.get("eventId");
                currentRoomId = params.get("roomId");
                const roomName = params.get("roomName");

                if (!currentEventId || !currentRoomId) {
                    document.body.innerHTML =
                        "<h1>Error: Event ID and Room ID are required.</h1><p><a href='/index.html'>Go back to lobby</a></p>";
                    return;
                }

                document.getElementById("room-name").textContent =
                    decodeURIComponent(roomName || "N/A");

                require.config({
                    paths: {
                        vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs",
                    },
                });

                joinRoom(currentEventId, currentRoomId);
                getProblemsForRoom(currentEventId, currentRoomId);

                window.addEventListener("resize", () => {
                    if (editor) editor.layout();
                });
            });
        </script>
    </body>
</html>
