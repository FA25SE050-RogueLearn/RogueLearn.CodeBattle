<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RogueLearn CodeBattle</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
                background-color: #f4f4f4;
            }
            .container {
                max-width: 1200px;
                margin: auto;
                background: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }
            h1,
            h2,
            h3 {
                color: #333;
            }
            .columns {
                display: flex;
                gap: 20px;
            }
            .col {
                flex: 1;
                min-width: 0;
            }
            #events,
            #rooms,
            #leaderboard,
            #problem {
                border: 1px solid #ddd;
                padding: 15px;
                border-radius: 5px;
                min-height: 200px;
            }
            button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            }
            button:hover {
                background-color: #0056b3;
            }
            ul {
                list-style-type: none;
                padding: 0;
            }
            li {
                background: #eee;
                margin-bottom: 5px;
                padding: 10px;
                border-radius: 3px;
                cursor: pointer;
            }
            li:hover {
                background: #ddd;
            }
            li.selected {
                background-color: #007bff;
                color: white;
            }
            #code-editor-container {
                width: 100%;
                height: 300px;
                border: 1px solid #ddd;
                margin-top: 10px;
                position: relative; /* Provides a positioning context */
            }
            #notifications {
                margin-top: 20px;
                border: 1px solid #ccc;
                padding: 10px;
                background-color: #f9f9f9;
                max-height: 200px;
                overflow-y: auto;
            }
            #submission-area {
                margin-top: 15px;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>
    </head>
    <body>
        <div class="container">
            <h1>RogueLearn CodeBattle Frontend</h1>

            <div class="columns">
                <div class="col">
                    <h2>Events</h2>
                    <div id="events">
                        <ul id="events-list"></ul>
                    </div>
                </div>
                <div class="col">
                    <h2>Rooms</h2>
                    <div id="rooms">
                        <ul id="rooms-list"></ul>
                    </div>
                </div>
            </div>

            <hr />

            <div class="columns">
                <div class="col">
                    <h2>Leaderboard</h2>
                    <div id="leaderboard">
                        <ul id="leaderboard-list">
                            <p>Select a room to see the leaderboard.</p>
                        </ul>
                    </div>
                </div>
                <div class="col">
                    <h2>Problems</h2>
                    <div id="problem">
                        <ul id="problems-list">
                            <p>Select a room to see problems.</p>
                        </ul>

                        <div id="submission-area" style="display: none">
                            <h3 id="selected-problem-title"></h3>
                            <div id="code-editor-container"></div>
                            <br />
                            <select id="language-selector">
                                <option value="go">Go</option>
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                            </select>
                            <button id="submit-code">Submit Solution</button>
                            <div
                                id="room-submission-result"
                                style="margin-top: 10px"
                            ></div>
                        </div>
                    </div>
                </div>
            </div>

            <hr />

            <h2>Exercises</h2>
            <div class="columns">
                <div class="col">
                    <h3>All Problems</h3>
                    <div id="exercise-problems">
                        <ul id="exercise-problems-list"></ul>
                    </div>
                </div>
                <div class="col">
                    <h3>Solve Problem</h3>
                    <div id="exercise-submission-area" style="display: none">
                        <h3 id="exercise-selected-problem-title"></h3>
                        <div
                            id="exercise-code-editor-container"
                            style="height: 300px; border: 1px solid #ddd"
                        ></div>
                        <br />
                        <select id="exercise-language-selector">
                            <option value="go">Go</option>
                            <option value="python">Python</option>
                            <option value="javascript">JavaScript</option>
                        </select>
                        <button id="exercise-submit-code">
                            Submit Solution
                        </button>
                        <div
                            id="exercise-submission-result"
                            style="margin-top: 10px"
                        ></div>
                    </div>
                </div>
            </div>

            <div id="notifications">
                <h2>Real-time Notifications</h2>
                <ul id="notifications-list"></ul>
            </div>
        </div>

        <script>
            const API_BASE_URL = "http://localhost:8080";
            const playerID = "11111111-1111-1111-1111-111111111111"; // Example player ID for dev

            let eventSource = null;
            let selectedEventId = null;
            let selectedRoomId = null;
            let selectedProblemId = null;
            let editor = null;
            let exerciseEditor = null; // New editor instance

            // --- Editor Functions ---
            function createEditor(initialLanguage, initialCode) {
                if (editor) {
                    return;
                }
                require(["vs/editor/editor.main"], () => {
                    editor = monaco.editor.create(
                        document.getElementById("code-editor-container"),
                        {
                            value: initialCode,
                            language: initialLanguage,
                            theme: "vs-dark",
                            automaticLayout: true,
                        },
                    );
                });
            }

            function createExerciseEditor(initialLanguage, initialCode) {
                if (exerciseEditor) {
                    exerciseEditor.setValue(initialCode);
                    monaco.editor.setModelLanguage(
                        exerciseEditor.getModel(),
                        initialLanguage,
                    );
                    exerciseEditor.layout();
                    return;
                }
                require(["vs/editor/editor.main"], () => {
                    exerciseEditor = monaco.editor.create(
                        document.getElementById(
                            "exercise-code-editor-container",
                        ),
                        {
                            value: initialCode,
                            language: initialLanguage,
                            theme: "vs-dark",
                            automaticLayout: true,
                        },
                    );
                });
            }

            // --- Helper Functions ---
            function clearSelection(list) {
                list.querySelectorAll("li").forEach((item) =>
                    item.classList.remove("selected"),
                );
            }

            function logNotification(message, type = "info") {
                const notificationsList =
                    document.getElementById("notifications-list");
                const li = document.createElement("li");
                li.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

                if (type === "success") {
                    li.style.backgroundColor = "#d4edda";
                    li.style.color = "#155724";
                } else if (type === "error") {
                    li.style.backgroundColor = "#f8d7da";
                    li.style.color = "#721c24";
                }

                notificationsList.appendChild(li);
                notificationsList.scrollTop = notificationsList.scrollHeight;
            }

            // --- API Functions ---
            async function getEvents() {
                try {
                    const response = await fetch(`${API_BASE_URL}/events`);
                    const data = await response.json();
                    const eventsList = document.getElementById("events-list");
                    eventsList.innerHTML = "";
                    if (data.data) {
                        data.data.forEach((event) => {
                            const li = document.createElement("li");
                            li.textContent = event.Title;
                            li.dataset.eventId = event.ID;
                            li.addEventListener("click", () => {
                                clearSelection(eventsList);
                                li.classList.add("selected");
                                selectedEventId = event.ID;
                                document.getElementById(
                                    "rooms-list",
                                ).innerHTML = "";
                                document.getElementById(
                                    "problems-list",
                                ).innerHTML =
                                    "<p>Select a room to see problems.</p>";
                                document.getElementById(
                                    "leaderboard-list",
                                ).innerHTML =
                                    "<p>Select a room to see the leaderboard.</p>";
                                document.getElementById(
                                    "submission-area",
                                ).style.display = "none";
                                selectedRoomId = null;
                                selectedProblemId = null;
                                getRooms(event.ID);
                            });
                            eventsList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Error fetching events:", error);
                    logNotification("Error fetching events.", "error");
                }
            }

            async function getExercises() {
                try {
                    const response = await fetch(`${API_BASE_URL}/problems`);
                    const data = await response.json();
                    const problemsList = document.getElementById(
                        "exercise-problems-list",
                    );
                    problemsList.innerHTML = "";
                    if (data.data) {
                        data.data.forEach((problem) => {
                            const li = document.createElement("li");
                            li.textContent = `${problem.Title} (Difficulty: ${problem.Difficulty})`;
                            li.dataset.problemId = problem.ID;
                            li.dataset.problemTitle = problem.Title;
                            li.addEventListener("click", async () => {
                                clearSelection(problemsList);
                                li.classList.add("selected");
                                selectedProblemId = problem.ID;
                                const problemTitle = li.dataset.problemTitle;

                                document.getElementById(
                                    "exercise-submission-result",
                                ).innerHTML = "";

                                document.getElementById(
                                    "exercise-submission-area",
                                ).style.display = "block";
                                document.getElementById(
                                    "exercise-selected-problem-title",
                                ).textContent = `Solving: ${problemTitle}`;

                                const language = document.getElementById(
                                    "exercise-language-selector",
                                ).value;
                                const details = await getProblemDetails(
                                    selectedProblemId,
                                    language,
                                );
                                const initialCode = details
                                    ? details.SolutionStub
                                    : `// Could not load template for ${problemTitle}\n`;

                                createExerciseEditor(language, initialCode);
                            });
                            problemsList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Error fetching exercises:", error);
                    logNotification("Error fetching exercises.", "error");
                }
            }

            async function getRooms(eventId) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/events/${eventId}/rooms`,
                    );
                    const data = await response.json();
                    const roomsList = document.getElementById("rooms-list");
                    roomsList.innerHTML = "";
                    if (data.data) {
                        data.data.forEach((room) => {
                            const li = document.createElement("li");
                            li.textContent = room.Name;
                            li.dataset.roomId = room.ID;
                            li.addEventListener("click", () => {
                                clearSelection(roomsList);
                                li.classList.add("selected");
                                selectedRoomId = room.ID;
                                document.getElementById(
                                    "submission-area",
                                ).style.display = "none";
                                selectedProblemId = null;
                                joinRoom(eventId, room.ID);
                                getProblems(eventId, room.ID);
                            });
                            roomsList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Error fetching rooms:", error);
                    logNotification(
                        `Error fetching rooms for event ${eventId}.`,
                        "error",
                    );
                }
            }

            async function getProblemDetails(problemId, language) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/problems/${problemId}/details?lang=${language}`,
                    );
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    if (data.success && data.data) {
                        return data.data;
                    } else {
                        logNotification(
                            `Could not fetch details for problem ${problemId} (${language}).`,
                            "error",
                        );
                        return null;
                    }
                } catch (error) {
                    console.error("Error fetching problem details:", error);
                    logNotification(
                        `Error fetching problem details for ${problemId}.`,
                        "error",
                    );
                    return null;
                }
            }

            async function getProblems(eventId, roomId) {
                const problemsList = document.getElementById("problems-list");
                problemsList.innerHTML = "<p>Loading problems...</p>";
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/events/${eventId}/rooms/${roomId}/problems`,
                    );
                    const data = await response.json();
                    problemsList.innerHTML = "";
                    if (data.data && data.data.length > 0) {
                        data.data.forEach((problem) => {
                            const li = document.createElement("li");
                            li.textContent = `${problem.Title} (Score: ${problem.Score})`;
                            li.dataset.problemId = problem.CodeProblemID;
                            li.dataset.problemTitle = problem.Title;

                            li.addEventListener("click", async () => {
                                clearSelection(problemsList);
                                li.classList.add("selected");
                                selectedProblemId = problem.CodeProblemID;
                                const problemTitle = li.dataset.problemTitle;

                                document.getElementById(
                                    "submission-area",
                                ).style.display = "block";
                                document.getElementById(
                                    "selected-problem-title",
                                ).textContent = `Solving: ${problemTitle}`;
                                document.getElementById(
                                    "room-submission-result",
                                ).innerHTML = ""; // Clear result area

                                const language =
                                    document.getElementById(
                                        "language-selector",
                                    ).value;
                                const details = await getProblemDetails(
                                    selectedProblemId,
                                    language,
                                );
                                const initialCode = details
                                    ? details.SolutionStub
                                    : `// Could not load template for ${problemTitle}\n`;

                                requestAnimationFrame(() => {
                                    if (!editor) {
                                        createEditor(language, initialCode);
                                    } else {
                                        editor.setValue(initialCode);
                                        monaco.editor.setModelLanguage(
                                            editor.getModel(),
                                            language,
                                        );
                                        editor.layout();
                                    }
                                });
                            });
                            problemsList.appendChild(li);
                        });
                    } else {
                        problemsList.innerHTML =
                            "<p>No problems found for this room.</p>";
                    }
                } catch (error) {
                    console.error("Error fetching problems:", error);
                    problemsList.innerHTML = "<p>Error fetching problems.</p>";
                    logNotification(
                        `Error fetching problems for room ${roomId}.`,
                        "error",
                    );
                }
            }

            function joinRoom(eventId, roomId) {
                if (eventSource) {
                    eventSource.close();
                }
                document.getElementById("leaderboard-list").innerHTML =
                    "<p>Connecting to leaderboard...</p>";

                const url = `${API_BASE_URL}/events/${eventId}/rooms/${roomId}/leaderboard?connected_player_id=${playerID}`;
                eventSource = new EventSource(url);

                eventSource.onopen = () => {
                    logNotification(
                        `SSE connection opened for room ${roomId}.`,
                    );
                };

                eventSource.onerror = (error) => {
                    console.error("EventSource failed:", error);
                    logNotification("SSE connection error.", "error");
                    document.getElementById("leaderboard-list").innerHTML =
                        "<p>Could not connect to leaderboard.</p>";
                    eventSource.close();
                };

                eventSource.addEventListener(
                    "CORRECT_SOLUTION_SUBMITTED",
                    (e) => {
                        const message =
                            "A correct solution was submitted! Leaderboard will update shortly.";
                        logNotification(message, "success");
                        const resultContainer = document.getElementById(
                            "room-submission-result",
                        );
                        if (resultContainer) {
                            resultContainer.innerHTML = `<div style="color: green;"><strong>Success!</strong> Solution Accepted.</div>`;
                        }
                    },
                );

                eventSource.addEventListener(
                    "WRONG_SOLUTION_SUBMITTED",
                    (e) => {
                        const eventData = JSON.parse(e.data);
                        const errorMessage =
                            eventData.Data || "Your solution failed.";
                        logNotification(
                            `Your solution failed: ${errorMessage}`,
                            "error",
                        );
                        const resultContainer = document.getElementById(
                            "room-submission-result",
                        );
                        if (resultContainer) {
                            resultContainer.innerHTML = `<div style="color: red;"><strong>Failed:</strong> ${errorMessage}</div>`;
                        }
                    },
                );

                eventSource.addEventListener("LEADERBOARD_UPDATED", (e) => {
                    logNotification("Leaderboard updated.");
                    const leaderboardList =
                        document.getElementById("leaderboard-list");
                    leaderboardList.innerHTML = ""; // Clear current leaderboard

                    try {
                        const eventPayload = JSON.parse(e.data);
                        const entries = eventPayload.Data; // The actual leaderboard is in the 'Data' field

                        if (Array.isArray(entries) && entries.length > 0) {
                            // Sort by place just in case the server doesn't guarantee order
                            entries.sort((a, b) => a.place - b.place);

                            entries.forEach((entry) => {
                                const li = document.createElement("li");
                                li.textContent = `#${entry.place} - ${entry.player_name} (Score: ${entry.score})`;
                                leaderboardList.appendChild(li);
                            });
                        } else {
                            leaderboardList.innerHTML =
                                "<p>No players on the leaderboard yet.</p>";
                        }
                    } catch (error) {
                        console.error(
                            "Error parsing leaderboard data:",
                            error,
                            "Raw data:",
                            e.data,
                        );
                        logNotification(
                            "Failed to update leaderboard.",
                            "error",
                        );
                        leaderboardList.innerHTML =
                            "<p>Error updating leaderboard.</p>";
                    }
                });

                eventSource.addEventListener("PLAYER_JOINED", (e) => {
                    logNotification("A player has joined the room.");
                });

                eventSource.addEventListener("PLAYER_LEFT", (e) => {
                    logNotification("A player has left the room.");
                });
            }

            document
                .getElementById("submit-code")
                .addEventListener("click", async () => {
                    if (!editor) {
                        alert("Editor is not initialized yet.");
                        return;
                    }
                    const code = editor.getValue();

                    if (
                        !selectedEventId ||
                        !selectedRoomId ||
                        !selectedProblemId
                    ) {
                        alert(
                            "Please select an event, room, and problem first.",
                        );
                        return;
                    }
                    if (!code.trim()) {
                        alert("Code editor cannot be empty.");
                        return;
                    }

                    const resultContainer = document.getElementById(
                        "room-submission-result",
                    );
                    resultContainer.innerHTML = `<div style="color: blue;">Submitting...</div>`;

                    const language =
                        document.getElementById("language-selector").value;
                    const url = `${API_BASE_URL}/events/${selectedEventId}/rooms/${selectedRoomId}/submit?player_id=${playerID}`;

                    try {
                        const response = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: "Bearer your-jwt-token",
                            },
                            body: JSON.stringify({
                                problem_id: selectedProblemId,
                                code: code,
                                language: language,
                            }),
                        });

                        const result = await response.json();
                        if (result.success) {
                            resultContainer.innerHTML = `<div style="color: blue;">${result.message}</div>`;
                            logNotification(
                                `Solution for problem ${selectedProblemId} submitted.`,
                            );
                        } else {
                            resultContainer.innerHTML = `<div style="color: red;">Submission failed: ${result.error_message}</div>`;
                            logNotification(
                                `Submission failed: ${result.error_message}`,
                                "error",
                            );
                        }
                    } catch (error) {
                        console.error("Error submitting solution:", error);
                        resultContainer.innerHTML = `<div style="color: red;">An error occurred while submitting your solution.</div>`;
                        logNotification("Error submitting solution.", "error");
                    }
                });

            document
                .getElementById("exercise-submit-code")
                .addEventListener("click", async () => {
                    if (!exerciseEditor) {
                        alert("Editor is not initialized yet.");
                        return;
                    }
                    const code = exerciseEditor.getValue();

                    if (!selectedProblemId) {
                        alert("Please select a problem first.");
                        return;
                    }
                    if (!code.trim()) {
                        alert("Code editor cannot be empty.");
                        return;
                    }

                    const language = document.getElementById(
                        "exercise-language-selector",
                    ).value;
                    const url = `${API_BASE_URL}/submissions`;
                    const resultContainer = document.getElementById(
                        "exercise-submission-result",
                    );
                    resultContainer.innerHTML = `<div style="color: blue;">Submitting...</div>`;

                    try {
                        const response = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                problem_id: selectedProblemId,
                                code: code,
                                language: language,
                            }),
                        });

                        const result = await response.json();
                        resultContainer.innerHTML = ""; // Clear previous result

                        if (result.success && result.data) {
                            if (result.data.success) {
                                let output = `<strong>Success!</strong> All test cases passed.`;
                                if (result.data.execution_time_ms) {
                                    output += `<br>Total Execution Time: ${result.data.execution_time_ms}`;
                                }
                                resultContainer.innerHTML = `<div style="color: #155724; padding: 10px; border: 1px solid #c3e6cb; border-radius: 5px; background-color: #d4edda; margin-top: 10px;">${output}</div>`;
                                logNotification(
                                    `Exercise solution for problem ${selectedProblemId} passed.`,
                                    "success",
                                );
                            } else {
                                const errorMessage =
                                    result.data.message ||
                                    "An unknown error occurred.";
                                resultContainer.innerHTML = `<div style="color: #721c24; padding: 10px; border: 1px solid #f5c6cb; border-radius: 5px; background-color: #f8d7da; margin-top: 10px;"><strong>Submission failed:</strong><pre style="white-space: pre-wrap; word-wrap: break-word;">${errorMessage}</pre></div>`;
                                logNotification(
                                    `Exercise submission failed: ${errorMessage}`,
                                    "error",
                                );
                            }
                        } else {
                            const errorMessage =
                                result.error_message ||
                                "An unknown server error occurred.";
                            resultContainer.innerHTML = `<div style="color: #721c24; padding: 10px; border: 1px solid #f5c6cb; border-radius: 5px; background-color: #f8d7da; margin-top: 10px;"><strong>Submission failed:</strong> ${errorMessage}</div>`;
                            logNotification(
                                `Submission failed: ${errorMessage}`,
                                "error",
                            );
                        }
                    } catch (error) {
                        console.error("Error submitting solution:", error);
                        resultContainer.innerHTML = `<div style="color: #721c24; padding: 10px; border: 1px solid #f5c6cb; border-radius: 5px; background-color: #f8d7da; margin-top: 10px;"><strong>An error occurred:</strong> ${error.message}</div>`;
                        logNotification("Error submitting solution.", "error");
                    }
                });

            document.addEventListener("DOMContentLoaded", () => {
                getEvents();
                getExercises(); // Fetch exercises on page load
                require.config({
                    paths: {
                        vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs",
                    },
                });

                document
                    .getElementById("language-selector")
                    .addEventListener("change", async (e) => {
                        const newLanguage = e.target.value;
                        if (editor) {
                            monaco.editor.setModelLanguage(
                                editor.getModel(),
                                newLanguage,
                            );

                            if (selectedProblemId) {
                                const details = await getProblemDetails(
                                    selectedProblemId,
                                    newLanguage,
                                );
                                const newCode = details
                                    ? details.SolutionStub
                                    : `// Could not load template for this language.\n`;
                                editor.setValue(newCode);
                            }
                        }
                    });

                document
                    .getElementById("exercise-language-selector")
                    .addEventListener("change", async (e) => {
                        const newLanguage = e.target.value;
                        if (exerciseEditor) {
                            monaco.editor.setModelLanguage(
                                exerciseEditor.getModel(),
                                newLanguage,
                            );

                            if (selectedProblemId) {
                                const details = await getProblemDetails(
                                    selectedProblemId,
                                    newLanguage,
                                );
                                const newCode = details
                                    ? details.SolutionStub
                                    : `// Could not load template for this language.\n`;
                                exerciseEditor.setValue(newCode);
                            }
                        }
                    });

                window.addEventListener("resize", () => {
                    if (editor) {
                        editor.layout();
                    }
                    if (exerciseEditor) {
                        exerciseEditor.layout();
                    }
                });
            });
        </script>
    </body>
</html>
