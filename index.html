<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RogueLearn CodeBattle</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
                background-color: #f4f4f4;
            }
            .container {
                max-width: 1200px;
                margin: auto;
                background: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }
            h1,
            h2,
            h3 {
                color: #333;
            }
            .columns {
                display: flex;
                gap: 20px;
            }
            .col {
                flex: 1;
                min-width: 0;
            }
            #events,
            #rooms,
            #event-leaderboard,
            #problem {
                border: 1px solid #ddd;
                padding: 15px;
                border-radius: 5px;
                min-height: 200px;
            }
            button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            }
            button:hover {
                background-color: #0056b3;
            }
            ul {
                list-style-type: none;
                padding: 0;
            }
            li {
                background: #eee;
                margin-bottom: 5px;
                padding: 10px;
                border-radius: 3px;
                cursor: pointer;
            }
            li:hover {
                background: #ddd;
            }
            li.selected {
                background-color: #007bff;
                color: white;
            }
            #notifications {
                margin-top: 20px;
                border: 1px solid #ccc;
                padding: 10px;
                background-color: #f9f9f9;
                max-height: 200px;
                overflow-y: auto;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>
    </head>
    <body>
        <div class="container">
            <h1>RogueLearn CodeBattle Lobby</h1>
            <p>
                Welcome, <strong id="player-name"></strong>! |
                <a href="#" id="logout-link">Logout</a>
            </p>

            <div class="columns">
                <div class="col">
                    <h2>Events</h2>
                    <div id="events">
                        <ul id="events-list"></ul>
                    </div>
                </div>
                <div class="col">
                    <h2>Rooms</h2>
                    <div id="rooms">
                        <p>Select an event to see its rooms.</p>
                        <ul id="rooms-list"></ul>
                    </div>
                </div>
                <div class="col">
                    <h2>Event Leaderboard</h2>
                    <div id="event-leaderboard">
                        <p>Select an event to see the leaderboard.</p>
                        <ul id="event-leaderboard-list"></ul>
                    </div>
                </div>
            </div>

            <hr />

            <h2>Manage Events</h2>
            <div id="manage-events-links">
                <p>
                    Want to host your own CodeBattle? Request a new event here.
                </p>
                <a href="./request-event.html"
                    ><button>Request New Event</button></a
                >
                <p style="margin-top: 20px">
                    Admins can manage event requests here.
                </p>
                <a href="./admin-requests.html"
                    ><button style="background-color: #6c757d">
                        Admin Dashboard
                    </button></a
                >
            </div>

            <hr />

            <h2>Exercises (Practice)</h2>
            <div class="columns">
                <div class="col">
                    <h3>All Problems</h3>
                    <div id="exercise-problems">
                        <ul id="exercise-problems-list"></ul>
                    </div>
                </div>
                <div class="col">
                    <h3>Solve Problem</h3>
                    <div id="exercise-submission-area" style="display: none">
                        <h3 id="exercise-selected-problem-title"></h3>
                        <div
                            id="exercise-code-editor-container"
                            style="height: 300px; border: 1px solid #ddd"
                        ></div>
                        <br />
                        <select id="exercise-language-selector">
                            <option value="go">Go</option>
                            <option value="python">Python</option>
                            <option value="javascript">JavaScript</option>
                        </select>
                        <button id="exercise-submit-code">
                            Submit Solution
                        </button>
                        <div
                            id="exercise-submission-result"
                            style="margin-top: 10px"
                        ></div>
                    </div>
                </div>
            </div>

            <div id="notifications">
                <h2>Real-time Notifications</h2>
                <ul id="notifications-list"></ul>
            </div>
        </div>

        <script>
            const API_BASE_URL = "http://localhost:8080";
            let playerID = null; // Will be set from localStorage

            let eventLeaderboardSource = null;
            let selectedEventId = null;
            let selectedProblemId = null; // For exercises
            let exerciseEditor = null;

            // --- Editor Functions for Exercises ---
            function createExerciseEditor(initialLanguage, initialCode) {
                if (exerciseEditor) {
                    exerciseEditor.setValue(initialCode);
                    monaco.editor.setModelLanguage(
                        exerciseEditor.getModel(),
                        initialLanguage,
                    );
                    exerciseEditor.layout();
                    return;
                }
                require(["vs/editor/editor.main"], () => {
                    exerciseEditor = monaco.editor.create(
                        document.getElementById(
                            "exercise-code-editor-container",
                        ),
                        {
                            value: initialCode,
                            language: initialLanguage,
                            theme: "vs-dark",
                            automaticLayout: true,
                        },
                    );
                });
            }

            // --- Helper Functions ---
            function clearSelection(list) {
                list.querySelectorAll("li").forEach((item) =>
                    item.classList.remove("selected"),
                );
            }

            function logNotification(message, type = "info") {
                const notificationsList =
                    document.getElementById("notifications-list");
                const li = document.createElement("li");
                li.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                if (type === "success") li.style.backgroundColor = "#d4edda";
                else if (type === "error") li.style.backgroundColor = "#f8d7da";
                notificationsList.appendChild(li);
                notificationsList.scrollTop = notificationsList.scrollHeight;
            }

            // --- API Functions ---
            async function getEvents() {
                try {
                    const response = await fetch(`${API_BASE_URL}/events`);
                    const data = await response.json();
                    const eventsList = document.getElementById("events-list");
                    eventsList.innerHTML = "";
                    if (data.data) {
                        data.data.forEach((event) => {
                            const li = document.createElement("li");
                            li.textContent = event.Title;
                            li.dataset.eventId = event.ID;
                            li.addEventListener("click", () => {
                                clearSelection(eventsList);
                                li.classList.add("selected");
                                selectedEventId = event.ID;
                                document.getElementById(
                                    "rooms-list",
                                ).innerHTML = "";
                                document.getElementById(
                                    "event-leaderboard-list",
                                ).innerHTML = "";
                                getRooms(event.ID);
                                spectateEvent(event.ID);
                            });
                            eventsList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Error fetching events:", error);
                    logNotification("Error fetching events.", "error");
                }
            }

            async function getRooms(eventId) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/events/${eventId}/rooms`,
                    );
                    const data = await response.json();
                    const roomsList = document.getElementById("rooms-list");
                    roomsList.innerHTML = "";
                    if (data.data) {
                        data.data.forEach((room) => {
                            const li = document.createElement("li");
                            li.textContent = `Join: ${room.Name}`;
                            li.dataset.roomId = room.ID;
                            li.addEventListener("click", () => {
                                // Navigate to the dedicated room page
                                window.location.href = `room.html?eventId=${eventId}&roomId=${room.ID}&roomName=${encodeURIComponent(
                                    room.Name,
                                )}`;
                            });
                            roomsList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Error fetching rooms:", error);
                    logNotification(
                        `Error fetching rooms for event ${eventId}.`,
                        "error",
                    );
                }
            }

            async function getProblemDetails(problemId, language) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/problems/${problemId}/details?lang=${language}`,
                    );
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    if (data.success && data.data) {
                        return data.data;
                    } else {
                        logNotification(
                            `Could not fetch details for problem ${problemId} (${language}).`,
                            "error",
                        );
                        return null;
                    }
                } catch (error) {
                    console.error("Error fetching problem details:", error);
                    logNotification(
                        `Error fetching problem details for ${problemId}.`,
                        "error",
                    );
                    return null;
                }
            }

            // --- Event (Guild) Leaderboard SSE ---
            function spectateEvent(eventId) {
                if (eventLeaderboardSource) {
                    eventLeaderboardSource.close();
                }
                const list = document.getElementById("event-leaderboard-list");
                list.innerHTML = "<p>Connecting to event leaderboard...</p>";

                const url = `${API_BASE_URL}/events/${eventId}/leaderboard`;
                eventLeaderboardSource = new EventSource(url);

                eventLeaderboardSource.onopen = () =>
                    logNotification(
                        `SSE connection opened for event ${eventId}.`,
                    );
                eventLeaderboardSource.onerror = () => {
                    logNotification(
                        "Event leaderboard SSE connection error.",
                        "error",
                    );
                    list.innerHTML =
                        "<p>Could not connect to event leaderboard.</p>";
                    eventLeaderboardSource.close();
                };

                eventLeaderboardSource.addEventListener(
                    "GUILD_LEADERBOARD_UPDATED",
                    (e) => {
                        logNotification("Event leaderboard updated.");
                        list.innerHTML = ""; // Clear
                        try {
                            const entries = JSON.parse(e.data).Data;
                            if (Array.isArray(entries) && entries.length > 0) {
                                entries.sort((a, b) => a.rank - b.rank);
                                entries.forEach((entry) => {
                                    const li = document.createElement("li");
                                    li.textContent = `#${
                                        entry.Rank
                                    } - Guild ${entry.GuildID.slice(
                                        0,
                                        8,
                                    )} (Score: ${entry.TotalScore})`;
                                    list.appendChild(li);
                                });
                            } else {
                                list.innerHTML =
                                    "<p>No guilds on the leaderboard yet.</p>";
                            }
                        } catch (error) {
                            console.error(
                                "Error parsing event leaderboard data:",
                                error,
                            );
                            list.innerHTML =
                                "<p>Error updating leaderboard.</p>";
                        }
                    },
                );
            }

            // --- Exercises Section Logic ---
            async function getExercises() {
                try {
                    const response = await fetch(`${API_BASE_URL}/problems`);
                    const data = await response.json();
                    const problemsList = document.getElementById(
                        "exercise-problems-list",
                    );
                    problemsList.innerHTML = "";
                    if (data.data) {
                        data.data.forEach((problem) => {
                            const li = document.createElement("li");
                            li.textContent = `${problem.Title} (Difficulty: ${problem.Difficulty})`;
                            li.dataset.problemId = problem.ID;
                            li.addEventListener("click", async () => {
                                clearSelection(problemsList);
                                li.classList.add("selected");
                                selectedProblemId = problem.ID;

                                document.getElementById(
                                    "exercise-submission-area",
                                ).style.display = "block";
                                document.getElementById(
                                    "exercise-selected-problem-title",
                                ).textContent = `Solving: ${problem.Title}`;

                                const language = document.getElementById(
                                    "exercise-language-selector",
                                ).value;
                                const details = await getProblemDetails(
                                    selectedProblemId,
                                    language,
                                );
                                const initialCode = details
                                    ? details.SolutionStub
                                    : `// Could not load template\n`;
                                createExerciseEditor(language, initialCode);
                            });
                            problemsList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Error fetching exercises:", error);
                    logNotification("Error fetching exercises.", "error");
                }
            }

            document
                .getElementById("exercise-submit-code")
                .addEventListener("click", async () => {
                    if (!exerciseEditor || !selectedProblemId) return;
                    const code = exerciseEditor.getValue();
                    if (!code.trim()) return alert("Code cannot be empty.");

                    const language = document.getElementById(
                        "exercise-language-selector",
                    ).value;
                    const url = `${API_BASE_URL}/submissions?player_id=${playerID}`;
                    const resultContainer = document.getElementById(
                        "exercise-submission-result",
                    );
                    resultContainer.innerHTML = `<div style="color: blue;">Submitting...</div>`;

                    try {
                        const response = await fetch(url, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                problem_id: selectedProblemId,
                                code: code,
                                language: language,
                            }),
                        });
                        const result = await response.json();
                        if (result.success && result.data) {
                            if (result.data.success) {
                                resultContainer.innerHTML = `<div style="color: green;"><strong>Success!</strong> All test cases passed.</div>`;
                            } else {
                                resultContainer.innerHTML = `<div style="color: red;"><strong>Failed:</strong><pre>${result.data.message}</pre></div>`;
                            }
                        } else {
                            resultContainer.innerHTML = `<div style="color: red;"><strong>Submission failed:</strong> ${result.error_message}</div>`;
                        }
                    } catch (error) {
                        console.error("Error submitting exercise:", error);
                        resultContainer.innerHTML = `<div style="color: red;">An error occurred.</div>`;
                    }
                });

            // --- Page Initialization ---
            document.addEventListener("DOMContentLoaded", () => {
                // --- AUTHENTICATION CHECK ---
                playerID = localStorage.getItem("codebattle_player_id");
                const playerName = localStorage.getItem(
                    "codebattle_player_name",
                );

                if (!playerID || !playerName) {
                    // If no player info, redirect to login
                    window.location.href = "/login.html";
                    return; // Stop further execution
                }

                // Display player name and setup logout
                document.getElementById("player-name").textContent = playerName;
                document
                    .getElementById("logout-link")
                    .addEventListener("click", (e) => {
                        e.preventDefault();
                        localStorage.removeItem("codebattle_player_id");
                        localStorage.removeItem("codebattle_player_name");
                        window.location.href = "/login.html";
                    });
                // --- END AUTHENTICATION CHECK ---

                getEvents();
                getExercises(); // Fetch exercises on page load
                require.config({
                    paths: {
                        vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs",
                    },
                });

                document
                    .getElementById("exercise-language-selector")
                    .addEventListener("change", async (e) => {
                        const newLanguage = e.target.value;
                        if (exerciseEditor && selectedProblemId) {
                            monaco.editor.setModelLanguage(
                                exerciseEditor.getModel(),
                                newLanguage,
                            );
                            const details = await getProblemDetails(
                                selectedProblemId,
                                newLanguage,
                            );
                            const newCode = details
                                ? details.SolutionStub
                                : `// Template not available.\n`;
                            exerciseEditor.setValue(newCode);
                        }
                    });

                window.addEventListener("resize", () => {
                    if (exerciseEditor) exerciseEditor.layout();
                });
            });
        </script>
    </body>
</html>
